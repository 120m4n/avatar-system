---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Registro - Avatar System">
  <div class="container">
    <h1>üé® Avatar System</h1>
    
    <div class="card" style="max-width: 500px; margin: 0 auto;">
      <h2>Crear Cuenta</h2>
      
      <div id="error-message" class="error" style="display: none;"></div>
      <div id="success-message" class="success" style="display: none;"></div>
      
      <form id="register-form">
        <div class="form-group">
          <label for="name">Nombre</label>
          <input type="text" id="name" name="name" required placeholder="Tu nombre" />
        </div>

        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required placeholder="tu@email.com" />
        </div>
        
        <div class="form-group">
          <label for="password">Contrase√±a</label>
          <input type="password" id="password" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8" />
        </div>
        
        <div class="form-group">
          <label for="passwordConfirm">Confirmar Contrase√±a</label>
          <input type="password" id="passwordConfirm" name="passwordConfirm" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8" />
        </div>
        
        <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
          Registrarse
        </button>
      </form>
      
      <div style="text-align: center; margin-top: 1rem;">
        <p style="color: #666;">
          ¬øYa tienes cuenta? <a href="/" style="color: #667eea; font-weight: 600;">Iniciar Sesi√≥n</a>
        </p>
      </div>
    </div>
  </div>

  <script>
    const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';

    const form = document.getElementById('register-form') as HTMLFormElement;
    const errorMessage = document.getElementById('error-message') as HTMLDivElement;
    const successMessage = document.getElementById('success-message') as HTMLDivElement;

    function showError(message: string) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
    }

    function showSuccess(message: string) {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = (document.getElementById('name') as HTMLInputElement).value;
      const email = (document.getElementById('email') as HTMLInputElement).value;
      const password = (document.getElementById('password') as HTMLInputElement).value;
      const passwordConfirm = (document.getElementById('passwordConfirm') as HTMLInputElement).value;

      if (password !== passwordConfirm) {
        showError('Las contrase√±as no coinciden');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/auth/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ name, email, password, passwordConfirm }),
        });

        const data = await response.json();

        if (response.ok) {
          showSuccess('¬°Registro exitoso! Redirigiendo al login...');
          
          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
        } else {
          const errorMsg = typeof data.details === 'object' 
            ? JSON.stringify(data.details) 
            : (data.details || data.error || 'Error al registrarse');
          showError(errorMsg);
        }
      } catch (error) {
        showError('Error de conexi√≥n. Por favor, verifica que el servidor est√© ejecut√°ndose.');
        console.error('Error:', error);
      }
    });
  </script>
</Layout>
