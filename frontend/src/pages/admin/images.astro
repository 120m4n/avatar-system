---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Admin - Gesti√≥n de Im√°genes">
  <div class="header">
    <div class="header-content">
      <h1>üñºÔ∏è Gesti√≥n de Im√°genes</h1>
      <div class="nav">
        <a href="/dashboard" class="btn btn-secondary">‚Üê Volver al Dashboard</a>
        <button id="logout-btn" class="btn btn-secondary">Cerrar Sesi√≥n</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div id="error-message" class="error" style="display: none;"></div>
      <div id="success-message" class="success" style="display: none;"></div>
      
      <!-- Create New Image Form -->
      <div class="create-section">
        <h2>Crear Nueva Imagen</h2>
        <form id="create-image-form" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
          <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
            <label for="alias">Alias</label>
            <input type="text" id="alias" name="alias" required placeholder="Nombre descriptivo de la imagen" />
          </div>
          <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
            <label for="image-file">Imagen</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <input type="file" id="image-file" accept="image/*" style="padding: 0.5rem; flex: 1;" />
              <button type="button" id="open-camera-btn" class="btn btn-secondary" title="Usar C√°mara">
                üì∑
              </button>
            </div>
          </div>
          <button type="submit" class="btn btn-primary" id="create-btn">
            ‚ûï Crear Imagen
          </button>
        </form>
        <!-- Camera preview for create form -->
        <div id="create-camera-preview" style="display: none; margin-top: 1rem;">
          <p style="color: #666; font-size: 0.9rem;">üì∑ Imagen capturada:</p>
          <img id="create-captured-image" src="" alt="Captura" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid #667eea;" />
          <button type="button" id="clear-capture-btn" class="btn btn-secondary" style="margin-left: 0.5rem; padding: 0.3rem 0.6rem;">‚úï Quitar</button>
        </div>
      </div>
      
      <hr style="margin: 2rem 0; border: none; border-top: 1px solid #e0e0e0;" />
      
      <!-- Images List -->
      <div class="images-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2>Listado de Im√°genes</h2>
          <button id="refresh-btn" class="btn btn-secondary">üîÑ Actualizar</button>
        </div>
        
        <div id="images-grid" class="images-grid">
          <p style="color: #666; text-align: center; grid-column: 1/-1;">Cargando im√°genes...</p>
        </div>
        
        <div id="pagination" class="pagination" style="margin-top: 1rem; display: flex; justify-content: center; gap: 0.5rem;">
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="edit-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Editar Imagen</h3>
      <form id="edit-image-form">
        <input type="hidden" id="edit-id" />
        <div class="form-group">
          <label for="edit-alias">Alias</label>
          <input type="text" id="edit-alias" name="alias" required />
        </div>
        <div class="form-group">
          <label for="edit-image-file">Nueva Imagen (opcional)</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="file" id="edit-image-file" accept="image/*" style="padding: 0.5rem; flex: 1;" />
            <button type="button" id="open-edit-camera-btn" class="btn btn-secondary" title="Usar C√°mara">
              üì∑
            </button>
          </div>
        </div>
        <div id="edit-preview" style="margin-bottom: 1rem;">
          <img id="edit-preview-img" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;" />
        </div>
        <!-- Camera preview for edit form -->
        <div id="edit-camera-preview" style="display: none; margin-bottom: 1rem;">
          <p style="color: #666; font-size: 0.9rem;">üì∑ Imagen capturada:</p>
          <img id="edit-captured-image" src="" alt="Captura" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid #667eea;" />
          <button type="button" id="edit-clear-capture-btn" class="btn btn-secondary" style="margin-left: 0.5rem; padding: 0.3rem 0.6rem;">‚úï Quitar</button>
        </div>
        <div style="display: flex; gap: 1rem;">
          <button type="submit" class="btn btn-primary">üíæ Guardar Cambios</button>
          <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Camera Modal -->
  <div id="camera-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <h3>üì∑ Capturar Imagen</h3>
      <div id="camera-error" class="error" style="display: none;"></div>
      <div id="camera-container" style="position: relative; margin-bottom: 1rem;">
        <video id="camera-video" autoplay playsinline style="width: 100%; border-radius: 8px; background: #000;"></video>
        <canvas id="camera-canvas" style="display: none;"></canvas>
      </div>
      <div id="camera-captured-container" style="display: none; margin-bottom: 1rem; text-align: center;">
        <img id="camera-captured-preview" src="" alt="Captura" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 2px solid #667eea;" />
      </div>
      <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
        <button type="button" id="capture-btn" class="btn btn-primary">üì∏ Capturar</button>
        <button type="button" id="retake-btn" class="btn btn-secondary" style="display: none;">üîÑ Volver a tomar</button>
        <button type="button" id="use-capture-btn" class="btn btn-primary" style="display: none;">‚úì Usar esta foto</button>
        <button type="button" id="cancel-camera-btn" class="btn btn-secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Cropper Modal -->
  <div id="cropper-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 90%; max-height: 90%;">
      <h3 style="margin-bottom: 1rem;">Recortar Imagen</h3>
      <div id="cropper-container" style="max-width: 100%; max-height: 60vh; overflow: hidden;">
        <img id="cropper-image" style="max-width: 100%; display: block;" />
      </div>
      <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.5rem;">
        <button id="cancel-crop-btn" class="btn btn-secondary">Cancelar</button>
        <button id="confirm-crop-btn" class="btn btn-primary">‚úì Confirmar Recorte</button>
      </div>
    </div>
  </div>

  <style>
    .create-section {
      margin-bottom: 2rem;
    }
    
    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
    }
    
    .image-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .image-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .image-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 0.75rem;
      background: #e0e0e0;
    }
    
    .image-card h4 {
      margin: 0 0 0.5rem 0;
      font-size: 1.1rem;
      color: #333;
      word-break: break-word;
    }
    
    .image-card .meta {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.75rem;
    }
    
    .image-card .actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .image-card .btn {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 1.5rem;
    }
    
    .pagination button {
      padding: 0.5rem 1rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #666;
    }
    
    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
  </style>

  <script>
    import Cropper from 'cropperjs';
    import 'cropperjs/dist/cropper.css';

    const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';
    
    let currentUser: any = null;
    let currentPage = 1;
    const perPage = 12;
    let cropper: Cropper | null = null;

    const errorMessage = document.getElementById('error-message') as HTMLDivElement;
    const successMessage = document.getElementById('success-message') as HTMLDivElement;
    const imagesGrid = document.getElementById('images-grid') as HTMLDivElement;
    const paginationDiv = document.getElementById('pagination') as HTMLDivElement;
    
    // Form elements
    const createForm = document.getElementById('create-image-form') as HTMLFormElement;
    const aliasInput = document.getElementById('alias') as HTMLInputElement;
    const imageFileInput = document.getElementById('image-file') as HTMLInputElement;
    const createBtn = document.getElementById('create-btn') as HTMLButtonElement;
    const refreshBtn = document.getElementById('refresh-btn') as HTMLButtonElement;
    const logoutBtn = document.getElementById('logout-btn') as HTMLButtonElement;
    
    // Edit modal elements
    const editModal = document.getElementById('edit-modal') as HTMLDivElement;
    const editForm = document.getElementById('edit-image-form') as HTMLFormElement;
    const editIdInput = document.getElementById('edit-id') as HTMLInputElement;
    const editAliasInput = document.getElementById('edit-alias') as HTMLInputElement;
    const editImageFileInput = document.getElementById('edit-image-file') as HTMLInputElement;
    const editPreviewImg = document.getElementById('edit-preview-img') as HTMLImageElement;
    const cancelEditBtn = document.getElementById('cancel-edit-btn') as HTMLButtonElement;

    // Camera elements
    const openCameraBtn = document.getElementById('open-camera-btn') as HTMLButtonElement;
    const openEditCameraBtn = document.getElementById('open-edit-camera-btn') as HTMLButtonElement;
    const cameraModal = document.getElementById('camera-modal') as HTMLDivElement;
    const cameraVideo = document.getElementById('camera-video') as HTMLVideoElement;
    const cameraCanvas = document.getElementById('camera-canvas') as HTMLCanvasElement;
    const cameraError = document.getElementById('camera-error') as HTMLDivElement;
    const cameraCapturedContainer = document.getElementById('camera-captured-container') as HTMLDivElement;
    const cameraCapturedPreview = document.getElementById('camera-captured-preview') as HTMLImageElement;
    const captureBtn = document.getElementById('capture-btn') as HTMLButtonElement;
    const retakeBtn = document.getElementById('retake-btn') as HTMLButtonElement;
    const useCaptureBtn = document.getElementById('use-capture-btn') as HTMLButtonElement;
    const cancelCameraBtn = document.getElementById('cancel-camera-btn') as HTMLButtonElement;
    
    // Cropper modal elements
    const cropperModal = document.getElementById('cropper-modal') as HTMLDivElement;
    const cropperImage = document.getElementById('cropper-image') as HTMLImageElement;
    const cancelCropBtn = document.getElementById('cancel-crop-btn') as HTMLButtonElement;
    const confirmCropBtn = document.getElementById('confirm-crop-btn') as HTMLButtonElement;
    
    // Create camera preview elements
    const createCameraPreview = document.getElementById('create-camera-preview') as HTMLDivElement;
    const createCapturedImage = document.getElementById('create-captured-image') as HTMLImageElement;
    const clearCaptureBtn = document.getElementById('clear-capture-btn') as HTMLButtonElement;
    
    // Edit camera preview elements
    const editCameraPreview = document.getElementById('edit-camera-preview') as HTMLDivElement;
    const editCapturedImage = document.getElementById('edit-captured-image') as HTMLImageElement;
    const editClearCaptureBtn = document.getElementById('edit-clear-capture-btn') as HTMLButtonElement;
    
    // Camera state
    let cameraStream: MediaStream | null = null;
    let capturedBlob: Blob | null = null;
    let cameraTarget: 'create' | 'edit' = 'create';
    // Persistent blobs for each form (not cleared by closeCamera)
    let createCapturedBlob: Blob | null = null;
    let editCapturedBlob: Blob | null = null;
    // Track blob URL for cropper to revoke it properly
    let currentCropperBlobUrl: string | null = null;

    function showError(message: string) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message: string) {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
      setTimeout(() => {
        successMessage.style.display = 'none';
      }, 5000);
    }

    // Camera functions
    async function openCamera(target: 'create' | 'edit') {
      cameraTarget = target;
      capturedBlob = null;
      cameraError.style.display = 'none';
      cameraCapturedContainer.style.display = 'none';
      cameraVideo.style.display = 'block';
      captureBtn.style.display = 'inline-block';
      retakeBtn.style.display = 'none';
      useCaptureBtn.style.display = 'none';

      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        cameraVideo.srcObject = cameraStream;
        cameraModal.style.display = 'flex';
      } catch (error) {
        console.error('Error accessing camera:', error);
        cameraError.textContent = 'No se pudo acceder a la c√°mara. Aseg√∫rate de permitir el acceso.';
        cameraError.style.display = 'block';
        cameraModal.style.display = 'flex';
      }
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      cameraVideo.srcObject = null;
    }

    function closeCamera() {
      stopCamera();
      cameraModal.style.display = 'none';
      capturedBlob = null;
    }

    function capturePhoto() {
      if (!cameraStream) return;

      const context = cameraCanvas.getContext('2d');
      if (!context) return;

      // Set canvas dimensions to match video
      cameraCanvas.width = cameraVideo.videoWidth;
      cameraCanvas.height = cameraVideo.videoHeight;
      
      // Draw video frame to canvas
      context.drawImage(cameraVideo, 0, 0);
      
      // Convert to blob
      cameraCanvas.toBlob((blob) => {
        if (blob) {
          capturedBlob = blob;
          cameraCapturedPreview.src = URL.createObjectURL(blob);
          cameraCapturedContainer.style.display = 'block';
          cameraVideo.style.display = 'none';
          captureBtn.style.display = 'none';
          retakeBtn.style.display = 'inline-block';
          useCaptureBtn.style.display = 'inline-block';
          stopCamera();
        }
      }, 'image/jpeg', 0.9);
    }

    async function retakePhoto() {
      capturedBlob = null;
      cameraCapturedContainer.style.display = 'none';
      cameraVideo.style.display = 'block';
      captureBtn.style.display = 'inline-block';
      retakeBtn.style.display = 'none';
      useCaptureBtn.style.display = 'none';
      
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        cameraVideo.srcObject = cameraStream;
      } catch (error) {
        console.error('Error accessing camera:', error);
        cameraError.textContent = 'No se pudo acceder a la c√°mara.';
        cameraError.style.display = 'block';
      }
    }

    function useCapturedPhoto() {
      if (!capturedBlob) return;

      // Close camera modal and open cropper
      closeCamera();
      const url = URL.createObjectURL(capturedBlob);
      openCropper(url);
    }

    function clearCameraCapture(target: 'create' | 'edit') {
      if (target === 'create') {
        // Clean up blob URL
        if (createCapturedImage.src && createCapturedImage.src.startsWith('blob:')) {
          URL.revokeObjectURL(createCapturedImage.src);
        }
        createCameraPreview.style.display = 'none';
        createCapturedImage.src = '';
        createCapturedBlob = null;
      } else {
        // Clean up blob URL
        if (editCapturedImage.src && editCapturedImage.src.startsWith('blob:')) {
          URL.revokeObjectURL(editCapturedImage.src);
        }
        editCameraPreview.style.display = 'none';
        editCapturedImage.src = '';
        editCapturedBlob = null;
      }
    }

    // Cropper functions
    function openCropper(imageUrl: string) {
      // Clean up previous blob URL if exists
      if (currentCropperBlobUrl) {
        URL.revokeObjectURL(currentCropperBlobUrl);
      }
      
      // Store the blob URL so we can revoke it later
      currentCropperBlobUrl = imageUrl;
      
      cropperImage.src = imageUrl;
      cropperModal.style.display = 'flex';
      
      // Initialize cropper after image loads
      cropperImage.onload = () => {
        if (cropper) {
          cropper.destroy();
        }
        cropper = new Cropper(cropperImage, {
          aspectRatio: 1,
          viewMode: 1,
          autoCropArea: 1,
          responsive: true,
          background: false,
        });
      };
    }

    function closeCropper() {
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      // Clean up blob URL
      if (currentCropperBlobUrl) {
        URL.revokeObjectURL(currentCropperBlobUrl);
        currentCropperBlobUrl = null;
      }
      cropperModal.style.display = 'none';
      cropperImage.src = '';
      
      // Clear file inputs when canceling cropper
      if (cameraTarget === 'create') {
        imageFileInput.value = '';
      } else {
        editImageFileInput.value = '';
      }
    }

    async function cropAndUseImage() {
      if (!cropper) return;

      const canvas = cropper.getCroppedCanvas({
        width: 400,
        height: 400,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
      });
      
      if (!canvas) return;

      canvas.toBlob((blob) => {
        if (blob) {
          closeCropper();
          
          // Store the cropped blob based on the camera target
          if (cameraTarget === 'create') {
            createCapturedBlob = blob;
            createCapturedImage.src = URL.createObjectURL(blob);
            createCameraPreview.style.display = 'block';
            imageFileInput.value = '';
          } else {
            editCapturedBlob = blob;
            editCapturedImage.src = URL.createObjectURL(blob);
            editCameraPreview.style.display = 'block';
            editImageFileInput.value = '';
          }
        }
      }, 'image/jpeg', 0.9);
    }

    // Check authentication and admin role
    async function checkAuth() {
      const token = localStorage.getItem('token');
      const user = localStorage.getItem('user');
      
      if (!token || !user) {
        window.location.href = '/';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/auth/me`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          currentUser = data.user;
          
          // Check admin role
          if (!currentUser.admin) {
            showError('Acceso denegado. Se requiere rol de administrador.');
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 2000);
            return;
          }
          
          loadImages();
        } else {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '/';
        }
      } catch (error) {
        console.error('Error checking auth:', error);
        showError('Error de conexi√≥n con el servidor');
      }
    }

    // Load images
    async function loadImages(page = 1) {
      const token = localStorage.getItem('token');
      if (!token) return;

      currentPage = page;

      try {
        const response = await fetch(`${API_URL}/api/admin/images?page=${page}&perPage=${perPage}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          renderImages(data.images);
          renderPagination(data.page, data.totalPages, data.totalItems);
        } else {
          const errorData = await response.json();
          showError(errorData.error || 'Error al cargar im√°genes');
        }
      } catch (error) {
        console.error('Error loading images:', error);
        showError('Error de conexi√≥n al cargar im√°genes');
      }
    }

    // Render images grid
    function renderImages(images: any[]) {
      if (images.length === 0) {
        imagesGrid.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <div class="icon">üñºÔ∏è</div>
            <h3>No hay im√°genes</h3>
            <p>Crea tu primera imagen usando el formulario de arriba.</p>
          </div>
        `;
        return;
      }

      // Fallback placeholder image as a constant
      const placeholderImage = 'data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Crect fill=%27%23f0f0f0%27 width=%27100%27 height=%27100%27/%3E%3Ctext x=%2750%27 y=%2755%27 text-anchor=%27middle%27 font-size=%2740%27%3EüñºÔ∏è%3C/text%3E%3C/svg%3E';

      imagesGrid.innerHTML = images.map(image => `
        <div class="image-card" data-id="${image.id}">
          <img src="${image.imageUrl}?size=medium" alt="${escapeHtml(image.alias)}" onerror="this.src='${placeholderImage}'" />
          <h4>${escapeHtml(image.alias)}</h4>
          <div class="meta">
            ID: ${image.id}<br>
            Creado: ${new Date(image.created).toLocaleDateString('es')}
          </div>
          <div class="actions">
            <button class="btn btn-primary edit-btn" data-id="${image.id}">‚úèÔ∏è Editar</button>
            <button class="btn btn-danger delete-btn" data-id="${image.id}">üóëÔ∏è Eliminar</button>
          </div>
        </div>
      `).join('');

      // Attach event listeners
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => openEditModal((btn as HTMLButtonElement).dataset.id!));
      });
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteImage((btn as HTMLButtonElement).dataset.id!));
      });
    }

    // Escape HTML for XSS prevention
    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Render pagination
    function renderPagination(page: number, totalPages: number, totalItems: number) {
      if (totalPages <= 1) {
        paginationDiv.innerHTML = `<span style="color: #666;">Total: ${totalItems} imagen(es)</span>`;
        return;
      }

      let html = '';
      
      if (page > 1) {
        html += `<button class="btn btn-secondary page-btn" data-page="${page - 1}">‚Üê Anterior</button>`;
      }
      
      html += `<span style="color: #666; padding: 0.5rem;">P√°gina ${page} de ${totalPages} (${totalItems} total)</span>`;
      
      if (page < totalPages) {
        html += `<button class="btn btn-secondary page-btn" data-page="${page + 1}">Siguiente ‚Üí</button>`;
      }
      
      paginationDiv.innerHTML = html;

      document.querySelectorAll('.page-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          loadImages(parseInt((btn as HTMLButtonElement).dataset.page!));
        });
      });
    }

    // Create image
    async function createImage(e: Event) {
      e.preventDefault();
      
      const token = localStorage.getItem('token');
      if (!token) return;

      const alias = aliasInput.value.trim();
      
      // Check if we have a cropped image (preview)
      if (!alias || !createCapturedBlob) {
        showError('Por favor completa todos los campos y sube una imagen');
        return;
      }

      createBtn.disabled = true;
      createBtn.textContent = 'Creando...';

      const formData = new FormData();
      formData.append('alias', alias);
      
      // Use cropped image
      formData.append('image', createCapturedBlob, 'image.jpg');

      try {
        const response = await fetch(`${API_URL}/api/admin/images`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          showSuccess('¬°Imagen creada exitosamente!');
          createForm.reset();
          // Clear camera capture preview
          clearCameraCapture('create');
          loadImages(1);
        } else {
          showError(data.error || 'Error al crear imagen');
        }
      } catch (error) {
        showError('Error de conexi√≥n al crear imagen');
        console.error('Create error:', error);
      } finally {
        createBtn.disabled = false;
        createBtn.textContent = '‚ûï Crear Imagen';
      }
    }

    // Open edit modal
    async function openEditModal(imageId: string) {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        const response = await fetch(`${API_URL}/api/admin/images/${imageId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          const image = data.image;
          
          editIdInput.value = image.id;
          editAliasInput.value = image.alias;
          editPreviewImg.src = image.imageUrl ? `${image.imageUrl}?size=medium` : '';
          editImageFileInput.value = '';
          
          editModal.style.display = 'flex';
        } else {
          showError('Error al cargar imagen');
        }
      } catch (error) {
        showError('Error de conexi√≥n');
        console.error('Error:', error);
      }
    }

    // Close edit modal
    function closeEditModal() {
      editModal.style.display = 'none';
      editForm.reset();
      // Clear camera capture for edit
      clearCameraCapture('edit');
    }

    // Update image
    async function updateImage(e: Event) {
      e.preventDefault();
      
      const token = localStorage.getItem('token');
      if (!token) return;

      const imageId = editIdInput.value;
      const alias = editAliasInput.value.trim();

      if (!alias) {
        showError('El alias es requerido');
        return;
      }

      const formData = new FormData();
      formData.append('alias', alias);
      
      // If we have a cropped image, include it
      if (editCapturedBlob) {
        formData.append('image', editCapturedBlob, 'image.jpg');
      }

      try {
        const response = await fetch(`${API_URL}/api/admin/images/${imageId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          showSuccess('¬°Imagen actualizada exitosamente!');
          closeEditModal();
          loadImages(currentPage);
        } else {
          showError(data.error || 'Error al actualizar imagen');
        }
      } catch (error) {
        showError('Error de conexi√≥n al actualizar imagen');
        console.error('Update error:', error);
      }
    }

    // Delete image
    async function deleteImage(imageId: string) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar esta imagen? Esta acci√≥n no se puede deshacer.')) {
        return;
      }

      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        const response = await fetch(`${API_URL}/api/admin/images/${imageId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();

        if (response.ok) {
          showSuccess('Imagen eliminada exitosamente');
          loadImages(currentPage);
        } else {
          showError(data.error || 'Error al eliminar imagen');
        }
      } catch (error) {
        showError('Error de conexi√≥n al eliminar imagen');
        console.error('Delete error:', error);
      }
    }

    // Event listeners
    createForm.addEventListener('submit', createImage);
    refreshBtn.addEventListener('click', () => loadImages(currentPage));
    editForm.addEventListener('submit', updateImage);
    cancelEditBtn.addEventListener('click', closeEditModal);
    
    // Close modal on background click
    editModal.addEventListener('click', (e) => {
      if (e.target === editModal) {
        closeEditModal();
      }
    });

    // Camera event listeners
    openCameraBtn.addEventListener('click', () => openCamera('create'));
    openEditCameraBtn.addEventListener('click', () => openCamera('edit'));
    captureBtn.addEventListener('click', capturePhoto);
    retakeBtn.addEventListener('click', retakePhoto);
    useCaptureBtn.addEventListener('click', useCapturedPhoto);
    cancelCameraBtn.addEventListener('click', closeCamera);
    clearCaptureBtn.addEventListener('click', () => clearCameraCapture('create'));
    editClearCaptureBtn.addEventListener('click', () => clearCameraCapture('edit'));
    
    // Cropper event listeners
    cancelCropBtn.addEventListener('click', closeCropper);
    confirmCropBtn.addEventListener('click', cropAndUseImage);
    
    // File input event listeners - open cropper when file is selected
    imageFileInput.addEventListener('change', (e) => {
      const file = imageFileInput.files?.[0];
      if (file) {
        cameraTarget = 'create';
        const url = URL.createObjectURL(file);
        openCropper(url);
      }
    });
    
    editImageFileInput.addEventListener('change', (e) => {
      const file = editImageFileInput.files?.[0];
      if (file) {
        cameraTarget = 'edit';
        const url = URL.createObjectURL(file);
        openCropper(url);
      }
    });
    
    // Close camera modal on background click
    cameraModal.addEventListener('click', (e) => {
      if (e.target === cameraModal) {
        closeCamera();
      }
    });
    
    // Close cropper modal on background click
    cropperModal.addEventListener('click', (e) => {
      if (e.target === cropperModal) {
        closeCropper();
      }
    });

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/';
    });

    // Initialize
    checkAuth();
  </script>
</Layout>
